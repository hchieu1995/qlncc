
(function ($) {
    app.modals.CreateNguoiDungModal = function () {

        var _quanLyCoCauToChucService = abp.services.qltd.quanLyCoCauToChuc;
        var _modalManager;
        var _$infoForm = null;
        var _$themTaiKhoanTable = $('#ThemTaiKhoanTable');
        this.init = function (modalManager) {
            _modalManager = modalManager;
            _$infoForm = _modalManager.getModal().find('form[name=InformationsForm]');
            _$infoForm.validate();
        };

        var dataTableTTK = _$themTaiKhoanTable.DataTable({
            pageLength: 15,
            lengthMenu: [10, 15, 25, 50, 100, 200, 500],
            paging: true,
            serverSide: true,
            processing: true,
            deferLoading: 0,
            responsive: false,
            listAction: {
                ajaxFunction: _quanLyCoCauToChucService.danhSachTaiKhoanThemMoi,
                inputFilter: function () {
                    return {
                        toChucId: $('#ToChucId').val(),
                        filter: $('#UsersTableFilter').val()
                    }
                }
            },
            columnDefs: [
                {
                    width: "25px",
                    searchable: false,
                    orderable: false,
                    className: "text-center",
                    render: function () {
                        return '';
                    },
                    targets: 0
                },
                {
                    targets: 1,
                    data: "nguoiDung_TaiKhoan",
                },
                {
                    targets: 2,
                    data: 'nguoiDung_HoTen',
                },
                {
                    targets: 3,
                    orderable: true,
                    data: "nguoiDung_Email"
                },
                {
                    targets: 4,
                    data: null,
                    orderable: false,
                    autoWidth: false,
                    className: "text-center",
                    defaultContent: '',
                    render: function (data) {
                        return "<label style='padding-left:2px' class='btn ml-1 mb-1 kt-checkbox kt-checkbox-outline checkbox-outline-2x kt-checkbox--primary'><input type='checkbox' class='btn editor-active ml-2 cb checktk' name='cb' data-id=" + data.id + " /><span></span></label>"
                    }
                },
            ],
            order: [[1, 'asc']]
        });
        dataTableTTK.on('draw.dt', function () {
            var PageInfo = dataTableTTK.page.info();
            dataTableTTK.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1 + PageInfo.start;
            });
        });

        $(`#GetUsersButton`).click(function () {
            dataTableTTK.ajax.reload();
        });

        $(`#checkallTK`).click(function () {
            if ($(this).is(":checked")) {
                $("#ThemTaiKhoanTable").find(".checktk").prop('checked', true);
            } else {
                $("#ThemTaiKhoanTable").find(".checktk").prop('checked', false);
            }
        });

        $("#DataTableYeuCau").on("click", ".checktk", function () {
            if ($(this).is(":checked")) {
                if ($("#ThemTaiKhoanTable").find(".checktk:checked").length == $("#ThemTaiKhoanTable").find(".checktk").length) {
                    $(`#checkallTK`).prop('checked', true);
                } else {
                    $(`#checkallTK`).prop('checked', false);
                }
            } else {
                $(`#checkallTK`).prop('checked', false);
            }
        });

        function LayDuLieu() {
            var lstid = [];
            $.each($("#ThemTaiKhoanTable").find(".checktk:checked"), function () {
                lstid.push($(this).attr("data-id"));
            })
            return lstid;
        }

        this.save = function () {
            _modalManager.setBusy(true);
            var input = new Object();
            input.toChucId = $('#ToChucId').val();
            var lst = [];

            $.each($("#ThemTaiKhoanTable").find(".checktk:checked"), function () {
                var obj_temp = new Object();
                obj_temp.UserId = $(this).attr("data-id");
                obj_temp.ChucVu = $('#chucvu_' + obj_temp.UserId).val();
                lst.push(obj_temp);
            });
            input.dsTaiKhoan = lst;

            if (lst.length > 0) {
                _quanLyCoCauToChucService.themMoiDanhSachTaiKhoan(input).done(function (res) {
                    if (res.success == true) {
                        abp.notify.info(app.localize('SavedSuccessfully'));
                        _modalManager.close();
                        abp.event.trigger('app.createNguoiDungModalSaved');
                    } else {
                        abp.notify.error(app.localize(res.message));
                    }
                }).always(function () {
                    _modalManager.setBusy(false);
                });
            }
            else {
                abp.notify.info(app.localize('Vui lòng chọn tài khoản'));
                _modalManager.setBusy(false);
            }
        };
        dataTableTTK.ajax.reload();
    }
})(jQuery);