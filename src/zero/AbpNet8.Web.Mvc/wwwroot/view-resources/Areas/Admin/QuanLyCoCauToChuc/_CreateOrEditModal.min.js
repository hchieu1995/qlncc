(function () {
    app.modals.CreateModal = function () {

        var _modalManager;
        var _quanLyCoCauToChucService = abp.services.qltd.quanLyCoCauToChuc;
        var _danhMucQuanHuyenService = abp.services.qltd.danhMucQuanHuyen;
        var _danhMucTinhThanhService = abp.services.qltd.danhMucTinhThanh;
        var _$tcInformationForm = null;

        this.init = function (modalManager) {
            _modalManager = modalManager;

            _$tcInformationForm = _modalManager.getModal().find('form[name=TcInformationsForm]');
            _$tcInformationForm.validate({ ignore: "" });
        };

        registerEvent();
        function registerEvent() {
            $('.combobox')
                .selectpicker({
                    iconBase: "fa",
                    tickIcon: "fa fa-check"
                });
        }

        $('#TinhThanh_Ma').on('change', function () {
            var tinhthanhma = $(this).val();
            let quanhuyen = $('#QuanHuyen_Ma');
            let phuongxa = $('#PhuongXa_Ma');
            quanhuyen.empty();
            phuongxa.empty();
            phuongxa.append('<option value=""> -- Chọn phường xã -- </option>');
            _danhMucTinhThanhService.getTinhThanhChangeModel(tinhthanhma).done(function (res) {
                quanhuyen.append('<option value=""> -- Chọn quận huyện -- </option>');
                if (res && res.dsQuanHuyen && res.dsQuanHuyen.length > 0) {
                    $.each(res.dsQuanHuyen, function (i, item) {
                        quanhuyen.append('<option value="' + item.value + '">' +
                            item.text + '</option>');
                    });
                    quanhuyen.selectpicker({
                        iconBase: "fa",
                        tickIcon: "fa fa-check"
                    });
                    quanhuyen.selectpicker('refresh');
                    phuongxa.selectpicker({
                        iconBase: "fa",
                        tickIcon: "fa fa-check"
                    });
                    phuongxa.selectpicker('refresh');
                }
                else {
                    quanhuyen.selectpicker('refresh');
                    phuongxa.selectpicker('refresh');
                }
            });
        });

        $('#QuanHuyen_Ma').on('change', function () {
            var quanhuyenma = $(this).val();
            let phuongxa = $('#PhuongXa_Ma');
            phuongxa.empty();
            _danhMucQuanHuyenService.getQuanHuyenChangeModel(quanhuyenma).done(function (res) {
                phuongxa.append('<option value=""> -- Chọn phường xã -- </option>');
                if (res && res.length > 0) {
                    $.each(res, function (i, item) {
                        phuongxa.append('<option value="' + item.xaPhuong_Ma + '">' +
                            item.xaPhuong_Ten + '</option>');
                    });
                    phuongxa.selectpicker({
                        iconBase: "fa",
                        tickIcon: "fa fa-check"
                    });
                    phuongxa.selectpicker('refresh');
                }
                else {
                    phuongxa.selectpicker('refresh');
                }
            });
        });

        $('.save-button').click(function () {
            var tc = _$tcInformationForm.serializeFormToObject();
            if (tc.Tc_Ma.trim() == "") {
                document.getElementById("Tc_Ma").focus();
                return abp.notify.warn("Mời bạn nhập mã!");
            }
            if (tc.Tc_Ten.trim() == "") {
                document.getElementById("Tc_Ten").focus();
                return abp.notify.warn("Mời bạn nhập tên!");
            }

            _modalManager.setBusy(true);
            _quanLyCoCauToChucService.createOrUpdate(tc).done(function (res) {
                if (res.success == true) {
                    abp.notify.info(app.localize('Lưu thông tin thành công'));
                    abp.event.trigger('app.createOrEditModalSaved');
                    _modalManager.close();
                } else {
                    abp.notify.error(res.message);
                }
            }).always(function () {
                _modalManager.setBusy(false);
            });
        });
    };
})();